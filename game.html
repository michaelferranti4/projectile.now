<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Desert Cab Dash</title>
    <link rel="stylesheet" href="game.css" />

    <!-- Brython runtime and standard library (from CDN) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython_stdlib.js"></script>
  </head>
  <body onload="brython()">
    <!-- Overlay shown until user starts the game -->
    <div
      id="start-overlay"
      style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
        color: #fff;
      "
    >
      <button id="start-btn" style="font-size: 24px; padding: 10px 20px;">
        Start Game
      </button>
    </div>

    <!-- Background music. Use the direct‐download URL from Google Drive -->
    <audio
      id="bg-music"
      src="https://drive.google.com/uc?export=download&id=1oNAz3b7ySGZocOWuD74cCJ3889x-0lwn"
      loop
      preload="auto"
    ></audio>

    <!-- Canvas for the game -->
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <!-- The Python game logic (Brython) -->
    <script type="text/python" src="game.py"></script>

    <!-- Script to start game and music after user interaction -->
    <script>
      const startBtn = document.getElementById('start-btn');
      const music = document.getElementById('bg-music');

      startBtn.addEventListener('click', () => {
        // Directly play() on click—no .load(), no promise-catch logic here.
        // This one line is the “user gesture” that Chrome recognizes.
        music.play().catch((err) => {
          // If it still fails, log the error so we can debug (CORS? invalid URL?)
          console.warn("Audio play() failed:", err);
        });

        if (window.start_game) {
          window.start_game();
        }
        document.getElementById('start-overlay').style.display = 'none';
      });
    </script>

    <!-- Swipe controls for mobile -->
    <script>
      let touchStartX = null;
      let touchStartY = null;
      document.addEventListener('touchstart', (e) => {
        const t = e.changedTouches[0];
        touchStartX = t.screenX;
        touchStartY = t.screenY;
      });
      document.addEventListener('touchend', (e) => {
        if (touchStartX === null || touchStartY === null) return;
        const t = e.changedTouches[0];
        const dx = t.screenX - touchStartX;
        const dy = t.screenY - touchStartY;
        if (Math.abs(dx) > Math.abs(dy)) {
          if (dx > 30) {
            window.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowRight' }));
          } else if (dx < -30) {
            window.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowLeft' }));
          }
        } else {
          if (dy > 30) {
            window.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowDown' }));
          } else if (dy < -30) {
            window.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowUp' }));
          }
        }
        touchStartX = null;
        touchStartY = null;
      });
    </script>
  </body>
</html>
